#===================================================================================
# Lisence: MIT
# Author: ccccmagicboy
# Url: https://ccrobot-online.com
#===================================================================================

name: MEEB_3DP Marlin v2

on:
  push:
    branches:
      - master
    paths:
    - '.github/workflows/marlin_v2.yml'
    - '!**.md'
    - '!**.xlsx'
    
  schedule:
    - cron: 0 20 * * *

env:
  INPUT_TZ1: Asia
  INPUT_TZ2: Shanghai
  REPO_URL: https://github.com/ccccmagicboy/Marlin.git
  REPO_BRANCH: meeb_3dp_board_pin_define
  
jobs:
  build:
    strategy:
      matrix:
        os:
        - ubuntu-18.04
        
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout this repos
      uses: actions/checkout@v2    
      
    - name: Clone the marlin source code
      run: |
        git clone --recursive $REPO_URL -b $REPO_BRANCH my_marlin

    - name: Select Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: '3.7' # Version range or exact version of a Python version to use, using semvers version range syntax.
        architecture: 'x64' # optional x64 or x86. Defaults to x64 if not specified   
        
    - name: Install PlatformIO
      run: |
        pip install -U https://github.com/platformio/platformio-core/archive/master.zip
        platformio update
        platformio --version
        
    - name: Run Tests
      working-directory: my_marlin
      run: |
        chmod +x buildroot/bin/*
        chmod +x buildroot/share/tests/*
        export PATH=./buildroot/bin/:./buildroot/share/tests/:${PATH}
        run_tests . STM32F103RC_cc_meeb_3dp
        
    - name: Config the Configuration.h/Configuration_adv.h
      working-directory: my_marlin
      run: |
        export PATH=/home/runner/work/MEEB_3DP/MEEB_3DP/my_marlin/buildroot/bin:$PATH
        restore_configs
        opt_set MOTHERBOARD BOARD_CCROBOT_MEEB_3DP
        opt_set SERIAL_PORT 1
        opt_set SERIAL_PORT_2 -1
        opt_set X_DRIVER_TYPE TMC2208
        opt_set Y_DRIVER_TYPE TMC2208
        opt_set Z_DRIVER_TYPE TMC2208
        opt_set E0_DRIVER_TYPE TMC2208
        
    - name: Complie the Marlin
      working-directory: my_marlin
      run: |
        platformio run -e STM32F103RC_cc_meeb_3dp
        cd .pio/build/STM32F103RC_cc_meeb_3dp
        ls -al
        cp ./firmware.bin ../../../../Marlin_v2/firmware.bin
          
    - name: Get the datetime
      id: get_datetime
      uses: ccccmagicboy/get_datetime@master
      with:
        tz1: 'Asia'
        tz2: 'Shanghai'        
        
    - name: Commit the new bin file
      working-directory: ./Marlin_v2
      run: |
        ls -al
        echo "::set-output name=ver::$(git describe --tags --always --dirty)"      
        git config --global user.email "ci_bot@ccrobot-online.com"
        git config --global user.name "ci_bot"
        git diff --name-only
        git add firmware.bin
        git commit -m "update the marlin v2 firmware: ${{ steps.get_datetime.outputs.datetime_str }}"
        git describe --tags --always --dirty="-dev"
        echo "::set-output name=ver::$(git describe --tags --always --dirty=\"-dev\")"
        git remote rm origin
        git remote add origin https://${{ secrets.GITHUB_ID }}:${{ secrets.GITHUB_PW }}@github.com/ccrobot-online/MEEB_3DP.git
        git push origin master
        echo "::set-output name=ver::$(git describe --tags --always --dirty)"        
        
      


      
      